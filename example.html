<div class="inline-drawer">
    <div class="inline-drawer-toggle inline-drawer-header">
        <b>VN Background Gen</b>
        <div id="kazuma_popout_toggle" class="fa-regular fa-window-restore" title="Toggle Pop-out Window"></div>
        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
    </div>

    <!-- THIS WRAPPER IS NEEDED FOR THE DRAWER TO OPEN/CLOSE -->
    <div class="inline-drawer-content">

        <!-- MODERN SETTINGS CONTAINER -->
        <div class="kazuma-settings">

            <!-- Group 1: Main Switches -->
            <div class="kazuma-group">
                <label class="kazuma-row" title="Turn the extension on/off">
                    <span><i class="fa-solid fa-power-off"></i> Enable Extension</span>
                    <input type="checkbox" id="kazuma_enable" />
                </label>
                <label class="kazuma-row" title="Fixes lag by compressing images">
                    <span><i class="fa-solid fa-compress"></i> Compress Images (Fix Lag)</span>
                    <input type="checkbox" id="kazuma_compress" />
                </label>
                <label class="kazuma-row" title="Show prompt popup for editing before generation">
                    <span><i class="fa-solid fa-bug"></i> Diagnostic Mode</span>
                    <input type="checkbox" id="kazuma_debug" />
                </label>
            </div>

            <!-- Group: Pop-out Window Settings -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-regular fa-window-restore"></i> Pop-out Window</div>
                <label class="kazuma-row" title="Display images in a floating pop-out window">
                    <span>Use Pop-out Window</span>
                    <input type="checkbox" id="kazuma_use_popout" />
                </label>
                <label class="kazuma-row" title="Automatically open pop-out when image is ready">
                    <span>Auto-open Pop-out</span>
                    <input type="checkbox" id="kazuma_auto_open_popout" />
                </label>
                <label class="kazuma-row" title="Show the prompt text below the image">
                    <span>Show Prompt in Pop-out</span>
                    <input type="checkbox" id="kazuma_show_prompt_popout" />
                </label>
                <label class="kazuma-row" title="Also save images to chat when using pop-out">
                    <span>Also Save to Chat</span>
                    <input type="checkbox" id="kazuma_also_save_chat" />
                </label>
            </div>

            <!-- Group 2: Automation & Prompting -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-robot"></i> Automation</div>

                <label class="kazuma-row">
                    <span>Auto-Generate</span>
                    <input type="checkbox" id="kazuma_auto_enable" />
                </label>

                <div class="kazuma-row">
                    <span>Every X replies:</span>
                    <input type="number" id="kazuma_auto_freq" class="text_pole" style="width: 60px" min="1" value="1"/>
                </div>

            </div>

            <!-- Group: Background Behavior -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-mountain-sun"></i> Background Behavior</div>

                <label class="kazuma-row" title="Automatically set generated image as SillyTavern background">
                    <span>Auto-Set as Background</span>
                    <input type="checkbox" id="kazuma_auto_set_bg" />
                </label>
            </div>

            <!-- Group: Scene State -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-map-location-dot"></i> Scene State</div>

                <div class="kazuma-sub-label">Location</div>
                <div class="kazuma-row" style="justify-content: space-between; align-items: center;">
                    <span id="kazuma_persist_location_tags" style="font-size: 0.85em; opacity: 0.8; flex: 1;">(none)</span>
                    <button class="menu_button" id="kazuma_persist_reset_location" style="padding: 2px 8px; font-size: 0.8em;">Reset</button>
                </div>

                <div class="kazuma-sub-label">Atmosphere</div>
                <div class="kazuma-row" style="justify-content: space-between; align-items: center;">
                    <span id="kazuma_persist_atmosphere_tags" style="font-size: 0.85em; opacity: 0.8; flex: 1;">(none)</span>
                    <button class="menu_button" id="kazuma_persist_reset_atmosphere" style="padding: 2px 8px; font-size: 0.8em;">Reset</button>
                </div>

                <div class="kazuma-sub-label">Time of Day</div>
                <div class="kazuma-row" style="justify-content: space-between; align-items: center;">
                    <span id="kazuma_persist_time_tags" style="font-size: 0.85em; opacity: 0.8; flex: 1;">(none)</span>
                    <button class="menu_button" id="kazuma_persist_reset_time" style="padding: 2px 8px; font-size: 0.8em;">Reset</button>
                </div>
            </div>

            <!-- Group: Scene Extraction API -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-robot"></i> Scene Extraction API</div>

                <div class="kazuma-sub-label">API Endpoint</div>
                <input id="kazuma_tag_endpoint" type="text" class="text_pole" style="width:100%; margin-bottom:8px;"
                       placeholder="https://api.openai.com/v1/chat/completions">

                <div class="kazuma-sub-label">API Key</div>
                <input id="kazuma_tag_api_key" type="password" class="text_pole" style="width:100%; margin-bottom:8px;"
                       placeholder="sk-...">

                <div class="kazuma-sub-label">Model</div>
                <input id="kazuma_tag_model" type="text" class="text_pole" style="width:100%;"
                       placeholder="gpt-4o-mini">
            </div>

            <!-- Group 3: ComfyUI Connection -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-link"></i> ComfyUI Server</div>

                <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="kazuma_url" class="text_pole" value="http://127.0.0.1:8188" placeholder="API URL" style="flex:1;" />
                    <button id="kazuma_test_btn" class="menu_button" title="Test Connection"><i class="fa-solid fa-wifi"></i></button>
                </div>

                <div class="kazuma-sub-label">Active Workflow</div>
                <div style="display:flex; gap:5px;">
                    <select id="kazuma_workflow_list" class="text_pole" style="flex:1"></select>
                    <button id="kazuma_new_workflow" class="menu_button fa-solid fa-plus" title="New"></button>
                    <button id="kazuma_edit_workflow" class="menu_button fa-solid fa-pen" title="Edit"></button>
                    <button id="kazuma_delete_workflow" class="menu_button fa-solid fa-trash" title="Delete"></button>
                </div>
            </div>

            <!-- Collapsible 1: Image Settings -->
            <details class="kazuma-details" open>
                <summary><i class="fa-solid fa-sliders"></i> Image Parameters</summary>
                <div class="kazuma-content">
                    <div class="kazuma-sub-label">Checkpoint / Model</div>
                    <select id="kazuma_model_list" class="text_pole" style="width:100%"></select>

                    <div class="kazuma-row" style="margin-top:10px;">
                        <span>Sampler</span>
                        <select id="kazuma_sampler_list" class="text_pole" style="width: 60%"></select>
                    </div>

                    <hr style="opacity:0.2; margin: 10px 0;">

                    <!-- Sliders -->
                    <div class="kazuma-slider-row">
                        <span>Steps</span>
                        <input type="range" id="kazuma_steps" min="1" max="100" />
                        <input type="number" id="kazuma_steps_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>CFG</span>
                        <input type="range" id="kazuma_cfg" min="1" max="30" step="0.5" />
                        <input type="number" id="kazuma_cfg_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>Denoise</span>
                        <input type="range" id="kazuma_denoise" min="0" max="1" step="0.05" />
                        <input type="number" id="kazuma_denoise_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>CLIP</span>
                        <input type="range" id="kazuma_clip" min="1" max="12" step="1" />
                        <input type="number" id="kazuma_clip_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-sub-label">Resolution</div>
                    <select id="kazuma_resolution_list" class="text_pole" style="width:100%; margin-bottom:5px;"></select>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="kazuma_width" class="text_pole" placeholder="W" style="flex:1">
                        <span>x</span>
                        <input type="number" id="kazuma_height" class="text_pole" placeholder="H" style="flex:1">
                    </div>

                     <div class="kazuma-sub-label">Seed (-1 for random)</div>
                    <input type="number" id="kazuma_seed" class="text_pole" style="width:100%">
                </div>
            </details>

            <!-- Collapsible 2: LoRA Lab -->
            <details class="kazuma-details">
                <summary><i class="fa-solid fa-flask"></i> LoRA Lab (4 Slots)</summary>
                <div class="kazuma-content">
                    <!-- Slot 1 -->
                    <div class="kazuma-lora-box">
                        <div class="kazuma-sub-label">LoRA 1</div>
                        <select id="kazuma_lora_list" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 2 -->
                     <div class="kazuma-lora-box">
                        <div class="kazuma-sub-label">LoRA 2</div>
                        <select id="kazuma_lora_list_2" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_2">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_2" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 3 -->
                    <div class="kazuma-lora-box">
                        <div class="kazuma-sub-label">LoRA 3</div>
                        <select id="kazuma_lora_list_3" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_3">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_3" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 4 -->
                    <div class="kazuma-lora-box">
                        <div class="kazuma-sub-label">LoRA 4</div>
                        <select id="kazuma_lora_list_4" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_4">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_4" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                </div>
            </details>

            <!-- Negative Prompt -->
            <div class="kazuma-group">
                <div class="kazuma-header">Negative Prompt Override</div>
                <textarea id="kazuma_negative" class="text_pole" rows="2" style="width:100%; font-size:12px; margin-top:5px;"></textarea>
            </div>

            <!-- Manual Action -->
            <button id="kazuma_gen_prompt_btn" class="menu_button" style="width:100%; padding: 10px;">
                <i class="fa-solid fa-mountain-sun"></i> Generate Background
            </button>
        </div>
    </div>
</div>
